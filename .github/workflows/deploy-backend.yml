name: Deploy Backend to AWS EC2

on:
  push:
    branches:
      - main
      - developer
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Check EC2 connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "echo 'Connection successful'"

      - name: Install Docker and Docker Compose on EC2 (if needed)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            # Check if Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo service docker start
              sudo usermod -a -G docker $USER
            fi

            # Check if Docker Compose is installed
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Verify installations
            docker --version
            docker-compose --version
          ENDSSH

      - name: Create deployment directory on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            mkdir -p ~/spms-backend
            mkdir -p ~/spms-backend/backend/logs
          ENDSSH

      - name: Copy files to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # Copy backend directory
          rsync -avz -e "ssh -i ~/.ssh/deploy_key.pem" \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '.env' \
            ./backend/ $EC2_USER@$EC2_HOST:~/spms-backend/backend/

          # Copy docker-compose.yml
          scp -i ~/.ssh/deploy_key.pem docker-compose.yml $EC2_USER@$EC2_HOST:~/spms-backend/

      - name: Create .env file on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << ENDSSH
            cat > ~/spms-backend/backend/.env << 'EOF'
          NODE_ENV=production
          PORT=3000
          DATABASE_URL=$DATABASE_URL
          JWT_SECRET=$JWT_SECRET
          JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET
          SUPABASE_URL=$SUPABASE_URL
          SUPABASE_KEY=$SUPABASE_KEY
          EOF
          ENDSSH

      - name: Deploy with Docker Compose
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            cd ~/spms-backend

            # Stop and remove existing containers
            sudo docker-compose down || true

            # Remove old images
            sudo docker image prune -af || true

            # Build and start containers
            sudo docker-compose up -d --build

            # Show running containers
            sudo docker-compose ps

            # Show logs
            sudo docker-compose logs --tail=50
          ENDSSH

      - name: Health check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            echo "Waiting for services to start..."
            sleep 15

            # Check if containers are running
            if sudo docker-compose -f ~/spms-backend/docker-compose.yml ps | grep -q "Up"; then
              echo "‚úÖ Containers are running"

              # Try to curl the health endpoint
              if curl -f http://localhost:3000/health 2>/dev/null; then
                echo "‚úÖ Health check passed"
              else
                echo "‚ö†Ô∏è  Health endpoint not responding yet"
              fi
            else
              echo "‚ùå Containers are not running"
              sudo docker-compose -f ~/spms-backend/docker-compose.yml logs
              exit 1
            fi
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key.pem

      - name: Deployment summary
        run: |
          echo "üöÄ Deployment completed successfully!"
          echo "Backend is running at: http://${{ secrets.EC2_HOST }}:3000"
          echo "Health check: http://${{ secrets.EC2_HOST }}:3000/health"
