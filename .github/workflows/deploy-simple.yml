name: Deploy to EC2 (Simple)

on:
  push:
    branches:
      - main
      - developer
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          BRANCH_NAME: ${{ github.ref_name }}
          USERNAME: ${{ secrets.EC2_USERNAME }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          envs: DATABASE_URL,JWT_SECRET,JWT_REFRESH_SECRET,SUPABASE_URL,SUPABASE_KEY,BRANCH_NAME,USERNAME,EC2_HOST
          script: |
            set -e

            # Check if repository directory exists
            if [ ! -d "/home/${USERNAME}/spms/.git" ]; then
              echo "ğŸ“ Repository not found. Cloning..."
              rm -rf /home/${USERNAME}/spms
              mkdir -p /home/${USERNAME}/spms
              cd /home/${USERNAME}/spms
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "ğŸ“ Repository found. Updating..."
              cd /home/${USERNAME}/spms
            fi

            # Pull latest changes
            echo "ğŸ”„ Pulling latest code from ${BRANCH_NAME}..."
            git fetch origin
            git checkout ${BRANCH_NAME}
            git reset --hard origin/${BRANCH_NAME}
            git pull origin ${BRANCH_NAME}

            # Create .env file for backend (note: no quotes around EOF)
            echo "âš™ï¸  Creating backend .env file..."
            cat > backend/.env << EOF
            NODE_ENV=production
            PORT=3000
            API_PREFIX=/api/v1
            DATABASE_URL=${DATABASE_URL}
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            SUPABASE_URL=${SUPABASE_URL}
            SUPABASE_KEY=${SUPABASE_KEY}
            ALLOWED_ORIGINS=http://${EC2_HOST},http://localhost:3000,http://localhost:5173
            USE_MOCK_DAN=true
            DAN_CLIENT_ID=mock-client-id
            DAN_CLIENT_SECRET=mock-client-secret
            DAN_API_URL=https://dan.gov.mn/api
            BCRYPT_ROUNDS=12
            LOG_LEVEL=info
            LOG_FILE_PATH=/app/logs
            EOF

            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down 2>/dev/null || true

            # Remove old images to save space
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=72h"

            # Build and start containers with frontend API URL
            # Using relative path since nginx proxies /api/ to backend
            echo "ğŸ”¨ Building and starting containers..."
            export VITE_API_URL="/api/v1"
            docker compose up -d --build

            # Wait for containers to be healthy
            echo "â³ Waiting for containers to start..."
            sleep 10

            # Show running containers
            echo "âœ… Deployment complete! Running containers:"
            docker compose ps

            # Show logs from last 20 lines
            echo "ğŸ“‹ Recent logs:"
            docker compose logs --tail=20

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Frontend: http://${{ secrets.EC2_HOST }}"
          echo "ğŸ”§ Backend API: http://${{ secrets.EC2_HOST }}:3000"
          echo "ğŸ“Š Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"